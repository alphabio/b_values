# Session 053: Declaration List Redesign

**Date:** 2025-11-07
**Focus:** Fix parseDeclarationList issues - duplicates, issue context, original field

---

## üö® Immediate Context

Session 052 completed a **critical audit** of `parseDeclarationList` after user testing revealed design gaps.

**Read first:** `docs/sessions/052/declaration-list-audit.md` (comprehensive analysis)

---

## ‚úÖ What Works

- Tests: 2205/2205 ‚úÖ
- Build: Passing ‚úÖ
- Typecheck: 0 errors ‚úÖ
- Lint: 0 warnings ‚úÖ
- Basic parsing: Works for simple cases
- Partial failure: Continues on invalid declarations

---

## üî¥ What's Broken

### 1. `original` Field Issue

```ts
parseDeclarationList("--angle: 10deg; --color: red")
// Returns: original: "10deg", "red"
// Problem: Only values, not full declarations
// Problem: Values are regenerated by csstree, not from source
```

**Question:** Keep, remove, or redesign this field?

### 2. No Issue Context

```ts
parseDeclarationList(`
  --angle: 10deg;
  background-image: INVALID;
  --color: red;
`)
// Issues: [{ property: "background-image", ... }]
// ‚ùå Which line? Which declaration index?
// ‚ùå DeclarationResult has no issues field
```

### 3. No Duplicate Handling

```ts
parseDeclarationList("--color: red; --color: blue; --color: green")
// Returns: 3 declarations
// Expected: CSS spec says "last wins" (only green?)
// Question: Or is returning all correct (CSSOM-like)?
```

### 4. Unclear Semantics

**What is the purpose of this function?**

- Option A: CSSOM-like array (all declarations, including duplicates)
- Option B: Property map (deduplicated, last wins)
- Option C: Both (two separate functions)

---

## üéØ Decisions Needed Before Coding

### Decision 1: Purpose

What should `parseDeclarationList` return?

- **Array of all declarations** (current) - good for tooling/validation
- **Map with last-wins** - good for inline styles/computed values
- **Both APIs** - `parseDeclarationList()` and `parseDeclarationMap()`

### Decision 2: Duplicates

- Return all duplicates (current behavior)?
- Filter to last-wins automatically?
- Add option parameter?

### Decision 3: Issue Tracking

**Option A:** Per-declaration issues
```ts
interface DeclarationResult {
  property: string;
  ir: T;
  issues: Issue[];  // NEW
}
```

**Option B:** Enhanced top-level issues
```ts
interface Issue {
  code: string;
  property?: string;
  declarationIndex?: number;  // NEW
  position?: { line: number; column: number };  // NEW
}
```

### Decision 4: `original` Field

- **Keep:** Fix to capture actual source (using css-tree positions)
- **Remove:** Not useful for clients, drop entirely
- **Redesign:** Make it actually useful (full declaration text?)

### Decision 5: Source Positions

Should we track line/column from css-tree AST?

Benefits: Better error reporting, can show exact location
Cost: More complex, need to thread original input through

---

## üìä Current State

**Architecture:**
- `parseDeclarationList()` uses css-tree with `context: "declarationList"`
- Calls `parseDeclaration()` for each declaration
- Collects results and issues
- Returns partial success (ok: true if any valid)

**Type hierarchy:**
```ts
DeclarationResult {
  property: string;
  ir: T;
  original: string;  // Problematic field
}

ParseResult<DeclarationResult[]> {
  ok: boolean;
  value: DeclarationResult[];
  issues: Issue[];  // Top-level only
}
```

**Key files:**
- `packages/b_declarations/src/declaration-list-parser.ts` (main impl)
- `packages/b_declarations/src/parser.ts` (single declaration)
- `packages/b_declarations/src/types.ts` (type definitions)

---

## üéØ Next Steps

### Step 1: Make Decisions

**User must decide:**
1. Purpose: Array-only, map-only, or both?
2. Duplicates: Keep all or last-wins?
3. Issues: Per-declaration or enhanced top-level?
4. `original` field: Keep, remove, or redesign?
5. Source positions: Track or not?

### Step 2: Update Types

Based on decisions, update:
- `DeclarationResult` interface
- `Issue` interface (if adding context)
- Add new types if needed (e.g., `DeclarationMap`)

### Step 3: Implement

- Update `parseDeclarationList` implementation
- Add duplicate handling if decided
- Add issue context tracking
- Fix or remove `original` field
- Extract source positions if decided

### Step 4: Update Tests

- Add tests for duplicate handling
- Add tests for issue context
- Update existing tests for type changes
- Test edge cases (syntax errors, all invalid, etc.)

### Step 5: Documentation

- Update JSDoc comments
- Add usage examples
- Document behavior clearly (duplicates, partial failures, etc.)
- Update session handover

---

## üí° Key Insights from Audit

1. **Implementation works** - all 21 tests pass
2. **Design is unclear** - purpose not defined
3. **Missing features** - duplicates, issue context, positions
4. **Type gaps** - `DeclarationResult` has no issues field
5. **`original` field** - current implementation not useful

**The code works, but what should it do?**

---

## üìÅ Session Artifacts

- `docs/sessions/052/declaration-list-audit.md` - Full analysis
- `docs/sessions/052/git-ref.txt` - Starting commit

---

**Session 053 Status:** üü° Awaiting design decisions

**Git ref:** ff5477130ed9c39b631827c58634c189e16d35e8

---

## Quick Reference

```bash
# Run affected tests
pnpm test declaration-list-parser.test.ts

# View implementation
cat packages/b_declarations/src/declaration-list-parser.ts

# View types
cat packages/b_declarations/src/types.ts

# Read full audit
cat docs/sessions/052/declaration-list-audit.md
```
